å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥

# å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥

## Overview

å¤ä¹ 

- äº’æ–¥ï¼šè‡ªæ—‹é”ã€äº’æ–¥é”ã€futex
- ~~æ˜¯æ—¶å€™é¢å¯¹çœŸæ­£çš„å¹¶å‘ç¼–ç¨‹äº†~~

---

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ

---

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- å…¸å‹çš„åŒæ­¥é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼›å“²å­¦å®¶åƒé¥­
- åŒæ­¥çš„å®ç°æ–¹æ³•ï¼šä¿¡å·é‡ã€æ¡ä»¶å˜é‡

# çº¿ç¨‹åŒæ­¥

## åŒæ­¥ (Synchronization)

ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»

- iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)
- å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)
- åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºé€Ÿåº¦ä¸€è‡´)
- åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)

---

å¼‚æ­¥ (Asynchronous) = ä¸åŒæ­¥

- ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)

## å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥

å¹¶å‘ç¨‹åºçš„æ­¥è°ƒå¾ˆéš¾ä¿æŒ â€œå®Œå…¨ä¸€è‡´â€

- çº¿ç¨‹åŒæ­¥ï¼š
	åœ¨æŸä¸ªæ—¶é—´ç‚¹å…±åŒè¾¾åˆ°äº’ç›¸å·²çŸ¥çš„çŠ¶æ€

---

å†æ¬¡æŠŠçº¿ç¨‹æƒ³è±¡æˆæˆ‘ä»¬è‡ªå·±

![](res/05.å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥/ge-166523028265743.jpg "")

- NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨/ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥
- èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­
- å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜
- jyy: ~~ç­‰æˆ‘æˆä¸ºå·ç‹å°±èººå¹³~~ 
	- â€œå…ˆåˆ°å…ˆç­‰â€

## ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†

> 99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³
> ã€‚

```
void Tproduce() { while (1) printf("("); }
void Tconsume() { while (1) printf(")"); }
```

åœ¨ `printf`  å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³

- ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€
- æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡ $n$
	- $n=3$, `((())())(((`  åˆæ³•
	- $n=3$, `(((())))` , `(()))`  ä¸åˆæ³•
- åŒæ­¥
	- ç­‰åˆ°æœ‰ç©ºä½å†æ‰“å°å·¦æ‹¬å·
	- ç­‰åˆ°èƒ½é…å¯¹æ—¶å†æ‰“å°å³æ‹¬å·

## ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šåˆ†æ

ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ

- å·¦æ‹¬å·ï¼šç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥é˜Ÿåˆ—
- å³æ‹¬å·ï¼šä»é˜Ÿåˆ—å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ

---

èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ

- å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³ $n$ æ—¶æ‰èƒ½æ‰“å°
- å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) $&gt;1$ æ—¶æ‰èƒ½æ‰“å°
	- å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº†	
		ï¼š[pc.c](https://jyywiki.cn/pages/OS/2022/demos/pc.c "")	
		- ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹
	- å‹åŠ›æµ‹è¯•çš„æ£€æŸ¥å½“ç„¶ä¸èƒ½å°‘ï¼š[pc-check.py](https://jyywiki.cn/pages/OS/2022/demos/pc-check.py "")
	- Model checker å½“ç„¶ä¹Ÿä¸èƒ½å°‘ (ç•™ä½œä¹ é¢˜)

# æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½åŒæ­¥æ–¹æ³•

## åŒæ­¥é—®é¢˜ï¼šåˆ†æ

> ä»»ä½•åŒæ­¥é—®é¢˜éƒ½
> æœ‰å…ˆæ¥å…ˆç­‰å¾…çš„æ¡ä»¶
> ã€‚

çº¿ç¨‹ join ([thread.h](https://jyywiki.cn/pages/OS/2022/demos/thread.h ""), [sum.c](https://jyywiki.cn/pages/OS/2022/demos/sum.c ""))

- ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸåç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç­‰å¾…

---

NPY çš„ä¾‹å­

- æ‰“å®Œæ¸¸æˆä¸”æ´—å®Œå¤´åç»§ç»­æ‰§è¡Œ `date()` ï¼Œå¦åˆ™ç­‰å¾…

---

ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜

- å·¦æ‹¬å·ï¼šæ·±åº¦ $k &lt; n$ æ—¶ `printf` ï¼Œå¦åˆ™ç­‰å¾…
- å³æ‹¬å·ï¼š$k &gt; 0$ æ—¶ `printf` ï¼Œå¦åˆ™ç­‰å¾…
	- å†çœ‹ä¸€çœ¼ [pc.c](https://jyywiki.cn/pages/OS/2022/demos/pc.c "")

## Conditional Variables (æ¡ä»¶å˜é‡, CV)

æŠŠ [pc.c](https://jyywiki.cn/pages/OS/2022/demos/pc.c "") ä¸­çš„è‡ªæ—‹å˜æˆç¡çœ 

- åœ¨å®Œæˆæ“ä½œæ—¶å”¤é†’

---

æ¡ä»¶å˜é‡ API

- wait(cv, mutex) ğŸ’¤
	- è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex
	- é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€
- signal/notify(cv) ğŸ’¬ ç§ä¿¡ï¼šèµ°èµ·
	- å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹
- broadcast/notifyAll(cv) ğŸ“£ æ‰€æœ‰äººï¼šèµ°èµ·
	- å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹

## æ¡ä»¶å˜é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

```
void Tproduce() {
  mutex_lock(&lk);
  if (count == n) cond_wait(&cv, &lk);
  printf("("); count++; cond_signal(&cv);
  mutex_unlock(&lk);
}

void Tconsume() {
  mutex_lock(&lk);
  if (count == 0) cond_wait(&cv, &lk);
  printf(")"); count--; cond_signal(&cv);
  mutex_unlock(&lk);
}
```

å‹åŠ›æµ‹è¯•ï¼š[pc-cv.c](https://jyywiki.cn/pages/OS/2022/demos/pc-cv.c "")ï¼›æ¨¡å‹æ£€éªŒï¼š[pc-cv.py](https://jyywiki.cn/pages/OS/2022/demos/pc-cv.py "")

- (Small scope hypothesis)

## æ¡ä»¶å˜é‡ï¼šæ­£ç¡®çš„æ‰“å¼€æ–¹å¼

éœ€è¦
ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶

```
mutex_lock(&mutex);
while (!cond) {
  wait(&cv, &mutex);
}
assert(cond);
// ...
// äº’æ–¥é”ä¿è¯äº†åœ¨æ­¤æœŸé—´æ¡ä»¶ cond æ€»æ˜¯æˆç«‹
// ...
mutex_unlock(&mutex);
```

å…¶ä»–çº¿ç¨‹æ¡ä»¶å¯èƒ½è¢«æ»¡è¶³æ—¶

```
broadcast(&cv);
```

- ä¿®æ”¹ [pc-cv.c](https://jyywiki.cn/pages/OS/2022/demos/pc-cv.c "") å’Œ [pc-cv.py](https://jyywiki.cn/pages/OS/2022/demos/pc-cv.py "")

## æ¡ä»¶å˜é‡ï¼šå®ç°å¹¶è¡Œè®¡ç®—

```
struct job {
  void (*run)(void *arg);
  void *arg;
}

while (1) {
  struct job *job;

  mutex_lock(&mutex);
  while (! (job = get_job()) ) {
    wait(&cv, &mutex);
  }
  mutex_unlock(&mutex);

  job->run(job->arg); // ä¸éœ€è¦æŒæœ‰é”
                      // å¯ä»¥ç”Ÿæˆæ–°çš„ job
                      // æ³¨æ„å›æ”¶åˆ†é…çš„èµ„æº
}
```

## æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜/é¢è¯•é¢˜

æœ‰ä¸‰ç§çº¿ç¨‹ï¼Œåˆ†åˆ«æ‰“å° `<` , `>` , å’Œ `_`

- å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—æ‰“å°å‡ºçš„åºåˆ—æ€»æ˜¯ `<><_`  å’Œ `><>_`  ç»„åˆ

---

ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œåªè¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š

- æ‰“å° â€œ`<` â€ çš„æ¡ä»¶ï¼Ÿ
- æ‰“å° â€œ`>` â€ çš„æ¡ä»¶ï¼Ÿ
- æ‰“å° â€œ`_` â€ çš„æ¡ä»¶ï¼Ÿ
	- [fish.c](https://jyywiki.cn/pages/OS/2022/demos/fish.c "")

# ä¿¡å·é‡

## å¤ä¹ ï¼šäº’æ–¥é”å’Œæ›´è¡£å®¤ç®¡ç†

![](res/05.å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥/locker-166523028265636.jpg "")

æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜

- å…ˆåˆ°çš„äºº (çº¿ç¨‹)
	- æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†
	- `*lk = ğŸ”’` ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›
- ååˆ°çš„äºº (çº¿ç¨‹)
	- ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…
	- çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)
- æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)
	- äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº
	- å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ
	- å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ`*lk = âœ…`
- ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„

## æ›´è¡£å®¤ç®¡ç†

å®Œå…¨æ²¡æœ‰å¿…è¦é™åˆ¶æ‰‹ç¯çš„æ•°é‡â€”â€”è®©æ›´å¤šåŒå­¦å¯ä»¥è¿›å…¥æ›´è¡£å®¤

- ç®¡ç†å‘˜å¯ä»¥æŒæœ‰ä»»æ„æ•°é‡çš„æ‰‹ç¯ (æ›´è¡£å®¤å®¹é‡ä¸Šé™)
	- å…ˆè¿›å…¥æ›´è¡£å®¤çš„åŒå­¦å…ˆå¾—åˆ°
	- æ‰‹ç¯ç”¨å®Œåæ‰éœ€è¦ç­‰åŒå­¦å‡ºæ¥

![](res/05.å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥/locker-166523028265636.jpg "")  v.s. ![](res/05.å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥/pool-2-166523028265637.jpg "")

## æ›´è¡£å®¤ç®¡ç† (by E.W. Dijkstra)

![](res/05.å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥/doraemon-166523028265638.gif "")

åšä¸€ç‚¹æ‰©å±•â€”â€”çº¿ç¨‹å¯ä»¥ä»»æ„ â€œå˜å‡ºâ€ ä¸€ä¸ªæ‰‹ç¯

- æŠŠæ‰‹ç¯çœ‹æˆæ˜¯ä»¤ç‰Œ
- å¾—åˆ°ä»¤ç‰Œçš„å¯ä»¥è¿›å…¥æ‰§è¡Œ
- å¯ä»¥éšæ—¶åˆ›å»ºä»¤ç‰Œ

---

â€œæ‰‹ç¯â€ = â€œä»¤ç‰Œâ€ = â€œä¸€ä¸ªèµ„æºâ€ = â€œä¿¡å·é‡â€ (semaphore)

- P(&amp;sem) - prolaag = try + decrease; wait; down; in
	- ç­‰å¾…ä¸€ä¸ªæ‰‹ç¯åè¿”å›
	- å¦‚æœæ­¤æ—¶ç®¡ç†å‘˜æ‰‹ä¸Šæœ‰ç©ºé—²çš„æ‰‹ç¯ï¼Œç«‹å³è¿”å›
- V(&amp;sem) - verhoog = increase; post; up; out
	- å˜å‡ºä¸€ä¸ªæ‰‹ç¯ï¼Œé€ç»™ç®¡ç†å‘˜
- ä¿¡å·é‡çš„è¡Œä¸ºå»ºæ¨¡: [sem.py](https://jyywiki.cn/pages/OS/2022/demos/sem.py "")

## ä¿¡å·é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

ä¿¡å·é‡è®¾è®¡çš„é‡ç‚¹

- è€ƒè™‘ â€œæ‰‹ç¯â€ (æ¯ä¸€å•ä½çš„ â€œ
	èµ„æº
	â€) æ˜¯ä»€ä¹ˆï¼Œè°åˆ›é€ ï¼Ÿè°è·å–ï¼Ÿ
	- [`pc-sem.c`](https://jyywiki.cn/pages/OS/2022/demos/pc-sem.c "")

```
void producer() {
  P(&empty);   // P()è¿”å› -> å¾—åˆ°æ‰‹ç¯
  printf("("); // å‡è®¾çº¿ç¨‹å®‰å…¨
  V(&fill);
}
void consumer() {
  P(&fill);
  printf(")");
  V(&empty);
}
```

- åœ¨ â€œä¸€å•ä½èµ„æºâ€ æ˜ç¡®çš„é—®é¢˜ä¸Šæ›´å¥½ç”¨

# å“²å­¦å®¶åƒé¥­é—®é¢˜

## å“²å­¦å®¶åƒé¥­é—®é¢˜ (E. W. Dijkstra, 1960)

å“²å­¦å®¶ (çº¿ç¨‹) æœ‰æ—¶æ€è€ƒï¼Œæœ‰æ—¶åƒé¥­

- åƒé¥­éœ€è¦åŒæ—¶å¾—åˆ°å·¦æ‰‹å’Œå³æ‰‹çš„å‰å­
- å½“å‰å­è¢«å…¶ä»–äººå æœ‰æ—¶ï¼Œå¿…é¡»ç­‰å¾…ï¼Œå¦‚ä½•å®ŒæˆåŒæ­¥ï¼Ÿ
	- å¦‚ä½•ç”¨äº’æ–¥é”/ä¿¡å·é‡å®ç°ï¼Ÿ

![](res/05.å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥/dining-philosophers-166523028265639.jpg "")

## å¤±è´¥ä¸æˆåŠŸçš„å°è¯•

å¤±è´¥çš„å°è¯•

- [philosopher.c](https://jyywiki.cn/pages/OS/2022/demos/philosopher.c "") (å¦‚ä½•è§£å†³ï¼Ÿ)

---

æˆåŠŸçš„å°è¯• (ä¸‡èƒ½çš„æ–¹æ³•)

```
mutex_lock(&mutex);
while (!(avail[lhs] && avail[rhs])) {
  wait(&cv, &mutex);
}
avail[lhs] = avail[rhs] = false;
mutex_unlock(&mutex);

mutex_lock(&mutex);
avail[lhs] = avail[rhs] = true;
broadcast(&cv);
mutex_unlock(&mutex);
```

## å¿˜äº†ä¿¡å·é‡ï¼Œè®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†å‰å­å§ï¼

â€œLeader/followerâ€ - ç”Ÿäº§è€…/æ¶ˆè´¹è€…

- åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸å¸¸è§çš„è§£å†³æ€è·¯ (HDFS, ...)

```
void Tphilosopher(int id) {
  send_request(id, EAT);
  P(allowed[id]); // waiter ä¼šæŠŠå‰å­é€’ç»™å“²å­¦å®¶
  philosopher_eat();
  send_request(id, DONE);
}

void Twaiter() {
  while (1) {
    (id, status) = receive_request();
    if (status == EAT) { ... }
    if (status == DONE) { ... }
  }
}
```

## å¿˜äº†é‚£äº›å¤æ‚çš„åŒæ­¥ç®—æ³•å§ï¼

ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œç®¡å‰å­çš„äººæ˜¯æ€§èƒ½ç“¶é¢ˆ

- ä¸€å¤§æ¡Œäººåƒé¥­ï¼Œæ¯ä¸ªäººéƒ½å«æœåŠ¡å‘˜çš„æ„Ÿè§‰
- Premature optimization is the root of all evil (D. E. Knuth)

---

æŠ›å¼€ workload è°ˆä¼˜åŒ–å°±æ˜¯è€æµæ°“

- åƒé¥­çš„æ—¶é—´é€šå¸¸è¿œè¿œå¤§äºè¯·æ±‚æœåŠ¡å‘˜çš„æ—¶é—´
- å¦‚æœä¸€ä¸ª manager æä¸å®šï¼Œå¯ä»¥åˆ†å¤šä¸ª (fast/slow path)
	- æŠŠç³»ç»Ÿè®¾è®¡å¥½ï¼Œä½¿é›†ä¸­ç®¡ç†ä¸æˆä¸ºç“¶é¢ˆ	
		- [Millions of tiny databases](https://www.usenix.org/conference/nsdi20/presentation/brooker "") (NSDI'20)

# æ€»ç»“

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ

---

Take-away message

- å®ç°åŒæ­¥çš„æ–¹æ³•
	- æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ï¼›ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜
	- Job queue å¯ä»¥å®ç°å‡ ä¹ä»»ä½•å¹¶è¡Œç®—æ³•
- ä¸è¦ â€œè‡ªä½œèªæ˜â€ è®¾è®¡ç®—æ³•ï¼Œå°å¿ƒæ±‚è¯

# End.https://jyywiki.cn/OS/2022/slides/6.slides#/1)