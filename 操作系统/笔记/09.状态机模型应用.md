çŠ¶æ€æœºæ¨¡å‹çš„åº”ç”¨

# çŠ¶æ€æœºæ¨¡å‹çš„åº”ç”¨

[è’‹ç‚å²©](http://ics.nju.edu.cn/~jyy "")

[![](res/09.çŠ¶æ€æœºæ¨¡å‹åº”ç”¨/nju-logo.jpg)](http://www.nju.edu.cn/ "")

[![](res/09.çŠ¶æ€æœºæ¨¡å‹åº”ç”¨/njucs-logo.jpg)](http://cs.nju.edu.cn/ "")

[![](res/09.çŠ¶æ€æœºæ¨¡å‹åº”ç”¨/ics-logo.png)](https://cs.nju.edu.cn/ics/ "")

## Overview

å¤ä¹ 

- çŠ¶æ€æœºï¼šç†è®º
	- æ•°å­—ç”µè·¯ï¼š[logisim.c](https://jyywiki.cn/pages/OS/2022/demos/logisim.c "") å’Œ [seven-seg.py](https://jyywiki.cn/pages/OS/2022/demos/seven-seg.py "")
	- Model checker: ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œçš„æ–°æ–¹æ³•
- çŠ¶æ€æœºï¼šå®è·µ
	- [thread-os.c](https://jyywiki.cn/pages/OS/2022/demos/thread-os.c "")

---

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : çŠ¶æ€æœºæ¨¡å‹å¦‚æ­¤æœ‰ç”¨ï¼Œè¿˜èƒ½æ›´æœ‰ç”¨ä¸€ç‚¹å—ï¼Ÿ

---

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- ç»ˆäºåšå®Œäº†é“ºå«ï¼Œæ˜¯æ—¶å€™è®©ä½ æ„Ÿå—åˆ° â€œçœŸæ­£çš„åŠ›é‡â€ äº†
	- éƒ½æ˜¯æ²¡ç”¨çš„å†…å®¹ï¼Œå½“æˆ‘å£èƒ¡å°±è¡Œäº†

# çŠ¶æ€æœºï¼šç†è§£æˆ‘ä»¬çš„ä¸–ç•Œ

## å“² â™‚ å­¦æ¢è®¨

æˆ‘ä»¬çš„ç‰©ç†ä¸–ç•Œæ˜¯ â€œç¡®å®šè§„åˆ™â€ çš„çŠ¶æ€æœºå—ï¼Ÿ

- å®è§‚ç‰©ç†ä¸–ç•Œè¿‘ä¼¼äº deterministic çš„çŠ¶æ€æœº (ç»å…¸åŠ›å­¦)
- å¾®è§‚ä¸–ç•Œå¯èƒ½æ˜¯ non-deterministic çš„ (é‡å­åŠ›å­¦)

---

æŠŠç‰©ç†ä¸–ç•Œå»ºæ¨¡æˆåŸºæœ¬ç²’å­çš„è¿åŠ¨

- [Conway's game of life](https://playgameoflife.com/ "")

## å“² â™‚ å­¦æ¢è®¨ (cont'd)

å¯ä»¥åœ¨è¿™ä¸ªæ¨¡å‹ä¸Šä¸¥è‚ƒåœ°å®šä¹‰å¾ˆå¤šæ¦‚å¿µï¼šé¢„æµ‹æœªæ¥ã€æ—¶é—´æ—…è¡Œâ€¦â€¦

- æˆä¸ºä½ ç†è§£ç‰©ç† (å’Œè®¡ç®—æœº) ä¸–ç•Œçš„å‚è€ƒ

---

ä¾‹å­

- Cellular automata ä¸æ”¯æŒ â€œæ—¶é—´æ—…è¡Œâ€
	- æ€ä¹ˆæ·»åŠ ä¸€ä¸ªå…¬ç†ä½¿å®ƒå¯ä»¥æ”¯æŒï¼Ÿ	
		- å¹³è¡Œå®‡å®™	
		- å¦‚æœä¸–ç•Œçº¿éœ€è¦åˆå¹¶ï¼Ÿå¯ä»¥[æ”¶æ•›äºæŸä¸ªåˆ†å¸ƒ](https://www.scientificamerican.com/article/time-travel-simulation-resolves-grandfather-paradox/ "")
- Cellular automata ä¸æ”¯æŒ â€œé¢„æµ‹å¤–æ¥â€
	- èƒ½å¦æ·»åŠ ä¸€ä¸ª syscall ä½¿å®ƒæ”¯æŒï¼Ÿ	
		- [Why philosophers should care about computational complexity, Ch. 10](https://www.scottaaronson.com/papers/philos.pdf "")

## çŠ¶æ€æœºæ¨¡å‹ï¼šç†è§£ç¼–è¯‘å™¨å’Œç°ä»£ CPU

ç¼–è¯‘å™¨ï¼šæºä»£ç  $S$ (çŠ¶æ€æœº) â†’ äºŒè¿›åˆ¶ä»£ç  $C$ (çŠ¶æ€æœº)
$$C = \textrm{compile}(S)$$

ç¼–è¯‘ (ä¼˜åŒ–) çš„æ­£ç¡®æ€§ (Soundness):

- $S$ ä¸ $C$ çš„å¯è§‚æµ‹è¡Œä¸ºä¸¥æ ¼ä¸€è‡´
	- system calls; volatile variable loads/stores; termination

---

è¶…æ ‡é‡ (superscalar)/ä¹±åºæ‰§è¡Œå¤„ç†å™¨

- å…è®¸åœ¨çŠ¶æ€æœºä¸Š â€œè·³è·ƒâ€
- [ilp-demo.c](https://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c "")

# æŸ¥çœ‹çŠ¶æ€æœºæ‰§è¡Œ

## Trace å’Œè°ƒè¯•å™¨

ç¨‹åºæ‰§è¡Œ = çŠ¶æ€æœºæ‰§è¡Œ

- æˆ‘ä»¬èƒ½ä¸èƒ½ â€œhackâ€ è¿›è¿™ä¸ªçŠ¶æ€æœº
	- è§‚å¯ŸçŠ¶æ€æœºçš„æ‰§è¡Œ	
		- strace/gdb
	- ç”šè‡³è®°å½•å’Œ	
		æ”¹å˜	
		çŠ¶æ€æœºçš„æ‰§è¡Œ

## åº”ç”¨ (1): Time-Travel Debugging

ç¨‹åºæ‰§è¡Œæ˜¯éšæ—¶é—´ â€œå‰è¿›â€ çš„ $ s_0 \to s_1 \to s_2 \to \ldots $

- èƒ½å¦åœ¨æ—¶é—´ä¸Š â€œåé€€â€ï¼Ÿ (time-travel)
	- ç»å¸¸ gdb ä¸å°å¿ƒ step è¿‡äº†ï¼Œä»å¤´å†æ¥â€¦â€¦
	- è®°å½•æ‰€æœ‰çš„ $s_i$ï¼Œå°±èƒ½å®ç°ä»»æ„çš„ time-traveling

---

è®°å½•æ‰€æœ‰ $s_i$ çš„å¼€é”€å¤ªå¤§ ($s_i$ ç”±å†…å­˜ + å¯„å­˜å™¨ç»„æˆ)

- ä½†
	ä¸€æ¡æŒ‡ä»¤çš„ side-effect é€šå¸¸æœ‰é™
	- åªè®°å½•åˆå§‹çŠ¶æ€ï¼Œå’Œæ¯æ¡æŒ‡ä»¤å‰åçŠ¶æ€çš„ diff
	- $s_0, \Delta_0, \Delta_1, \ldots $
	- æ­£å‘æ‰§è¡Œï¼š$s_{i+1} = s_i + \Delta_0$
	- åå‘æ‰§è¡Œï¼š$s_{i-1} = s_i e \Delta_0^{-1}$

## åº”ç”¨ (1): Time-Travel Debugging (cont'd)

gdb çš„éšè—åŠŸèƒ½ (å¤§å®¶è¯»è¿‡ gdb çš„æ‰‹å†Œäº†å—ï¼Ÿ)

- `record full`  - å¼€å§‹è®°å½•
- `record stop`  - ç»“æŸè®°å½•
- `reverse-step` /`reverse-stepi`  - â€œæ—¶é—´æ—…è¡Œè°ƒè¯•â€

---

ä¾‹å­ï¼šè°ƒè¯• [rdrand.c](https://jyywiki.cn/pages/OS/2022/demos/rdrand.c "")

- Reverse execution ä¸æ˜¯ä¸‡èƒ½çš„
	- æœ‰äº›å¤æ‚çš„æŒ‡ä»¤ (syscall) æ— æ³•ä¿è¯

## åº”ç”¨ (2): Record &amp; Replay

åœ¨ç¨‹åºæ‰§è¡Œæ—¶è®°å½•ä¿¡æ¯ï¼Œç»“æŸåé‡ç°ç¨‹åºçš„è¡Œä¸º

- ç¡®å®šçš„ç¨‹åºä¸éœ€è¦ä»»ä½•è®°å½•
	- å‡è®¾ $s_0$ æ‰§è¡Œ 1,000,000 æ¡ç¡®å®šçš„æŒ‡ä»¤åå¾—åˆ° $s'$	
		- é‚£ä¹ˆåªè¦è®°å½• $s_0$ å’Œ 1,000,000	
		- å°±èƒ½é€šè¿‡ â€œå†æ‰§è¡Œä¸€æ¬¡â€ æ¨å¯¼å‡º $s'$

## åº”ç”¨ (2): Record &amp; Replay (cont'd)

Record &amp; Replay: åªéœ€è®°å½• non-deterministic çš„æŒ‡ä»¤çš„
æ•ˆæœ

- (å•çº¿ç¨‹) åº”ç”¨ç¨‹åº
	- syscall, rdrand, rdtsc, ...
	- rr (Mozilla)	
		- (CACM'20)
- (å•å¤„ç†å™¨) æ“ä½œç³»ç»Ÿ
	- mmio, in, out, rdrand, rdtsc, ä¸­æ–­, ...
	- QEMU (`-icount shift=auto,rr=record,rrfile=replay.bin` )	
		- (OSDI'02, Best Paper ğŸ…)

# é‡‡æ ·çŠ¶æ€æœºæ‰§è¡Œ

## å…³äºæ€§èƒ½ä¼˜åŒ–

> Premature optimization is the root of all evil. (D. E. Knuth)

é‚£åˆ°åº•æ€ä¹ˆæ ·æ‰ç®— mature å‘¢ï¼Ÿ

- çŠ¶æ€æœºçš„æ‰§è¡Œéœ€è¦æ—¶é—´ï¼›å¯¹è±¡éœ€è¦å ç”¨ç©ºé—´
- éœ€è¦ç†è§£å¥½ â€œæ—¶é—´èŠ±åœ¨å“ªé‡Œâ€ã€â€œä»€ä¹ˆå¯¹è±¡å ç”¨äº†ç©ºé—´â€

---

![](res/09.çŠ¶æ€æœºæ¨¡å‹åº”ç”¨/safari-profiling.png "")

æˆ‘ä»¬éœ€è¦çœŸå®æ‰§è¡Œçš„
æ€§èƒ½æ‘˜è¦
ï¼

- æœ¬è´¨çš„å›ç­”ï¼šâ€œä¸ºäº†åšæŸä»¶äº‹åˆ°åº•èŠ±å»äº†å¤šå°‘èµ„æºâ€
- ç®€åŒ–çš„å›ç­”ï¼šâ€œä¸€æ®µæ—¶é—´å†…èµ„æºçš„æ¶ˆè€—æƒ…å†µâ€

## Profiler å’Œæ€§èƒ½æ‘˜è¦

> æ€§èƒ½æ‘˜è¦éœ€è¦å¯¹ç¨‹åºæ‰§è¡Œæ€§èƒ½å½±å“æœ€å°ï¼Œå¾€å¾€ä¸éœ€è¦ full traceã€‚

éš”ä¸€æ®µæ—¶é—´ â€œæš‚åœâ€ ç¨‹åºã€è§‚å¯ŸçŠ¶æ€æœºçš„æ‰§è¡Œ

- ä¸­æ–­å°±å¯ä»¥åšåˆ°
- å°†çŠ¶æ€ $s \to s'$ â€œè®°è´¦â€
	- æ‰§è¡Œçš„è¯­å¥
	- å‡½æ•°è°ƒç”¨æ ˆ
	- æœåŠ¡çš„è¯·æ±‚
- å¾—åˆ°ç»Ÿè®¡æ„ä¹‰çš„æ€§èƒ½æ‘˜è¦

---

ä¾‹å­ï¼šLinux Kernel perf (æ”¯æŒç¡¬ä»¶ PMU) - [ilp-demo.c](https://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c "")

- perf list, perf stat (-e), perf record, perf report

## å®é™…ä¸­çš„æ€§èƒ½ä¼˜åŒ–

ä½ ä»¬é‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µ

- äºŒå…«å®šå¾‹ï¼š80% çš„æ—¶é—´æ¶ˆè€—åœ¨éå¸¸é›†ä¸­çš„å‡ å¤„ä»£ç 
- L1 (pmm): å°å†…å­˜åˆ†é…æ—¶çš„ lock contention
	- profiler ç›´æ¥å¸®ä½ è§£å†³é—®é¢˜

---

å·¥ä¸šç•Œé‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µ

- æœ¨æ¡¶æ•ˆåº”ï¼šæ¯ä¸ªéƒ¨åˆ†éƒ½å·²ç» tune åˆ°å±€éƒ¨æœ€ä¼˜äº†
	- å‰©ä¸‹çš„éƒ¨åˆ†è¦ä¹ˆ profiler ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¦ä¹ˆå°±ä¸å¥½è§£å†³
	- (å·¥ç¨‹å¸ˆæ•´å¤©éƒ½å¯¹ç€ profiler çœ‹å¾—å¤´éƒ½å¤§äº†)
	- [The flame graph](https://cacm.acm.org/magazines/2016/6/202665-the-flame-graph/fulltext "") (CACM'16)

# Model Checker/Verifier

## Model Checker çš„å¨åŠ›å¤§å®¶å·²ç»çŸ¥é“äº†

150 è¡Œä»£ç çš„ [model-checker.py](https://jyywiki.cn/pages/OS/2022/demos/model-checker.py "")

- è¯å®Œæ‰€æœ‰ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ä¸Šæ¶‰åŠçš„å¹¶å‘ç¨‹åº
- å¤ç° OSTEP æ•™ç§‘ä¹¦ä¸Šçš„å¹¶å‘ bug (æ¡ä»¶å˜é‡é”™è¯¯å”¤é†’)

---

ä¸€äº›çœŸæ­£çš„ model checkers

- [TLA+](https://lamport.azurewebsites.net/tla/tla.html "") by Leslie Lamport;
- [Java PathFinder (JFP)](https://ti.arc.nasa.gov/tech/rse/vandv/jpf/ "") å’Œ [SPIN](http://spinroot.com/ "")
	- å®ƒä»¬éƒ½å–œæ¬¢ç”¨ Peterson ç®—æ³•åš tutorial ğŸ˜

## Model Checker: ä¸ä»…æ˜¯å¹¶å‘

ä»»ä½• â€œnon-deterministicâ€ çš„çŠ¶æ€æœºéƒ½å¯ä»¥æ£€æŸ¥

```
u32 x = rdrand();
u32 y = rdrand();
if (x > y)
  if (x * x + y * y == 65)
    bug();
...
assert(ptr); // å¯èƒ½ç©ºæŒ‡é’ˆå—ï¼Ÿ
```

---

æ›´é«˜æ•ˆçš„ Model Checker: â€œå°†ç›¸ä¼¼çŠ¶æ€åˆå¹¶â€

- [KLEE: Unassisted and automatic generation of high-coverage tests for complex systems programs](https://dl.acm.org/doi/10.5555/1855741.1855756 "") (OSDI'08, Best Paper ğŸ…)
- åŸºäº LLVM bitcode è§£é‡Šå™¨å®ç°

# æ€»ç»“

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : çŠ¶æ€æœºçš„è§†è§’ç»™äº†æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ

---

Take-away messages

- ç¼–ç¨‹ (çŠ¶æ€æœº) å°±æ˜¯å…¨ä¸–ç•Œ
- çŠ¶æ€æœºå¯ä»¥å¸®æˆ‘ä»¬
	- å»ºç«‹ç‰©ç†ä¸–ç•Œçš„å…¬ç†ä½“ç³»
	- ç†è§£è°ƒè¯•å™¨ã€Trace, profiler
	- è‡ªåŠ¨åˆ†æç¨‹åºçš„æ‰§è¡Œ (model checker)

# End.