ç°ä»£å­˜å‚¨ç³»ç»Ÿ

# ç°ä»£å­˜å‚¨ç³»ç»Ÿ

[è’‹ç‚å²©](http://ics.nju.edu.cn/~jyy "")

[![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/nju-logo.jpg)](http://www.nju.edu.cn/ "")

[![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/njucs-logo.jpg)](http://cs.nju.edu.cn/ "")

[![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/ics-logo.png)](https://cs.nju.edu.cn/ics/ "")

## Overview

å¤ä¹ 

- Xv6 æ–‡ä»¶ç³»ç»Ÿ
	- I/O è®¾å¤‡
	- Buffer cache
	- Log
	- åº”ç”¨ç¨‹åº

---

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : ç°ä»£åº”ç”¨ç¨‹åºå¦‚ä½•ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Ÿ

---

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- å…³ç³»æ•°æ®åº“
- Key-Value å­˜å‚¨ç³»ç»Ÿ

# æ–‡ä»¶ç³»ç»Ÿçš„èƒ½åŠ›å’Œå±€é™

## ä¾‹å­ï¼š[jyywiki.cn](http://jyywiki.cn/ "") Online Judge

ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ•°æ®

- æ¯ä¸ªè¯¾ç¨‹æ˜¯ä¸€ä¸ª
	ç›®å½•
	- åå•å­˜æ”¾åœ¨ students.csv (TOKEN ç”±è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ)
- æäº¤ä»¥æ–‡ä»¶å½¢å¼å­˜æ”¾åœ¨
	è¯¾ç¨‹/å­¦å·
	- `xxxxxxxx-2022-04-30-22-09-52.tar.bz2`
	- `xxxxxxxx-2022-04-30-22-09-52.tar.bz2.results` 	
		- ç”± Online Judge åæ®µè¯„æµ‹åé€šè¿‡ scp æ‹·è´
- ä¾‹å­ï¼šæ˜¾ç¤ºè¯„æµ‹ç»“æœ

```
for f in wiki.UPLOAD_PATH.glob(
    f'{course}/{module}/{stuid}/{file_pattern}'):
    if not f.name.endswith('.result'):
        # f æ˜¯ä¸€ä¸ªæäº¤
```

## å¯èƒ½ä½ ä»¬æ²¡æƒ³åˆ° OJ å°±æ˜¯ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Ÿ

æ–‡ä»¶ç³»ç»Ÿï¼šä¼˜ç‚¹

- æœ‰å·¨é‡çš„ UNIX å·¥å…·/æ ‡å‡†åº“å¯ä»¥å¤„ç†æ–‡ä»¶
	- å®¹æ˜“æŸ¥çœ‹ã€è°ƒè¯•ã€hacking
- ä¾‹å­
	- `find OS2022/L1 -name "*.result" | xargs rm`
	- `spam template.md OS2022/students.csv`

---

æ–‡ä»¶ç³»ç»Ÿï¼šå±€é™

- ä½ scalability
	- ä»»ä½•é¡µé¢æ¸²æŸ“éƒ½æ¶‰åŠå…¨é‡ç›®å½•éå†
- ä½å¯é æ€§
	- å‡ ä¹æ— æ³•æŠµæŠ—å´©æºƒ (ä¾‹å¦‚å¯èƒ½æœ‰å¤±æ•ˆçš„ .result)

# å…³ç³»æ•°æ®åº“

## Structured Query Language (SQL)

â€œEverything is a tableâ€

- SQL æè¿°å‡º â€œä½ æƒ³åšä»€ä¹ˆâ€ï¼Œæ•°æ®åº“å¼•æ“å¸®ä½  â€œæƒ³åŠæ³•æ‰§è¡Œâ€
	- ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–

```
SELECT *
FROM students, submissions
WHERE submission.sid = students.sid AND
      submissions.course = 'OS2022' AND
      submissions.module = 'M1';
```

```
for stu in students:
    for sub in submissions:
        if (stu.sid, sub.course, sub.module) ==
           (sub.sid, 'OS2022', 'M1'):
            yield stu, sub
```

## æ•°æ®åº“äº‹åŠ¡

![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/apio2022-workers.jpg "")

â€œACIDâ€ - Atomicity, Consistency, Isolation, Durability

- è¿™å¯ä¸æ˜¯ â€œä¸€æŠŠå¤§é”ä¿å¹³å®‰â€ èƒ½è§£å†³çš„
- å…è®¸æ•°åƒä¸ªè¿æ¥çš„å¹¶å‘äº‹åŠ¡
	- Web 2.0 æ—¶ä»£ç½‘ç»œåå°åº”ç”¨çš„æ”¯æŸ±
	- ä¾‹å­ï¼šæ›´å¤§è§„æ¨¡ç”Ÿäº§éƒ¨ç½²çš„ Online Judge

```
BEGIN WORK;
-- All or nothing
INSERT INTO students VALUES (...);
INSERT INTO students VALUES (...);
INSERT INTO students VALUES (...);
COMMIT;
```

## æ•°æ®åº“çš„å®ç°

è™šæ‹Ÿç£ç›˜ (æ–‡ä»¶) ä¸Šçš„æ•°æ®ç»“æ„

- æŠŠ SQL æŸ¥è¯¢ç¿»è¯‘æˆ read, write, lseek, fsync çš„è°ƒç”¨
- å¹¶å‘æ§åˆ¶ (äº‹åŠ¡å¤„ç†)

---

æƒ³å­¦ä¹ å¦‚ä½•å®ç°ï¼Ÿ

- [Bustub](https://github.com/cmu-db/bustub "") from [CMU 15-445](https://15445.courses.cs.cmu.edu/fall2021/assignments.html "")
	- L0 - C++ Primer
	- L1 - Buffer Pool Manager
	- L2 - Hash Index
	- L3 - Query Execution
	- L4 - Concurrency Control
- [SQLite](https://www.sqlite.org/index.html "")

# èµ°å‘æ–°æ—¶ä»£

## å­˜å‚¨ç³»ç»Ÿå¦‚ä½•åº”å¯¹æµ·é‡ã€å®æ—¶æ•°æ®ï¼Ÿ

![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/hdd-capacity.png "")

(1990s: é«˜é€Ÿç½‘ç»œ + æ•°æ®ä¸­å¿ƒå°†å¯ä»¥å­˜å‚¨æ•´ä¸ªäº’è”ç½‘ â†’ Google Search)

## å­˜å‚¨ç³»ç»Ÿå¦‚ä½•åº”å¯¹æµ·é‡ã€å®æ—¶æ•°æ®ï¼Ÿ (cont'd)

![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/social-media.webp "")

(2010s: æ²¡æœ‰å…³ç³»æ•°æ®åº“å¯ä»¥å†æ”¯æ’‘ç¤¾äº¤ç½‘ç»œ â†’ Key-Value Storage)

## å†æ¬¡é‡è§ CAP Theorem

![](res/29.ç°ä»£å­˜å‚¨ç³»ç»Ÿ/CAP-theorem.png "")

æ„é€  planet-scale æ•°æ®åº“é­é‡å‰æ‰€æœªæœ‰çš„æŒ‘æˆ˜

- éœ€è¦ä¸€ä¸ª â€œSLED v.s. RAIDâ€ ä¼¼çš„åˆ›æ–°

## åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€

â€œåˆ†å¸ƒå¼å…±è¯†åè®®â€

- [In search of an understandable consensus algorithm](https://raft.github.io/ "") (USENIX ATC'14, Best Paper Award ğŸ…)
	- â€œReplicated State Machinesâ€	
		- åˆæ˜¯çŠ¶æ€æœºï¼
	- [RaftScope](https://raft.github.io/raftscope/index.html "") Visualization Tool	
		- å†æ¬¡æ„Ÿå—è¢«å¹¶å‘ç¼–ç¨‹æ”¯é…çš„ææƒ§	
		- ä¸ä»…å¹¶å‘ï¼Œè€Œä¸”çº¿ç¨‹å¯èƒ½éšæ—¶æ¶ˆå¤±ï¼

## æ›´ä¸ºåˆ†å¸ƒå¼å‹å¥½çš„æ•°æ®æ¨¡å‹ï¼šKey-Value

[LevelDB](https://github.com/google/leveldb "") Key-Value Storage

- å•è¿›ç¨‹ (å¤šçº¿ç¨‹)ï¼ŒæŒ‰ key æ’åº
- æ”¯æŒ transactions
- æ”¯æŒå¿«ç…§ (å¯¹æŸä¸ªçŠ¶æ€çš„ç¬æ—¶åªè¯»å¿«ç…§)

---

ä¸€ç§å®ç°æ–¹æ³•ï¼šæ—¥å¿—

- `snapshot()`  è¿”å›å½“å‰æ–‡ä»¶çš„é•¿åº¦
- `put(k, v)`  éƒ½ç›´æ¥æŠŠ (k, v) è¿½åŠ å†™å…¥åˆ°æ–‡ä»¶å°¾éƒ¨
	- æ•ˆç‡æé«˜
- `get(k, v)`  éå†æ•´ä¸ªæ–‡ä»¶
	- æ•ˆç‡æä½ (â€œè¯»æ”¾å¤§â€) â†’ æ€ä¹ˆåŠï¼Ÿ

## Log-structured Merge (LSM) Trees

ä¸€ä¸ªæ¨¡æ‹Ÿå‡ºçš„ â€œMemory Hierarchyâ€

- å†™å…¥ç›´æ¥ append to log file
- Crash safe; ä¸èƒ½æ›´å¿«äº†

---

è§£å†³è¯»æ”¾å¤§

- ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œå…ˆåœ¨å†…å­˜ä¸­ç»´æŠ¤ log çš„å®æ—¶æ•°æ®ç»“æ„ (memtable)
	- get å¯ä»¥å…ˆåœ¨å†…å­˜
- Level 0: ç›´æ¥æŠŠ memtable dump åˆ°ç£ç›˜
	- æŸ¥æ‰¾å¤±è´¥æ—¶ï¼Œä¼šåˆ°ä¸‹ä¸€å±‚ç»§ç»­æŸ¥æ‰¾
- Level 1: åœ¨ Level 0 æ»¡ (4MB) æ—¶ï¼Œæ’åºæ‰€æœ‰ keyï¼Œä¸ Level 1 åˆå¹¶
	- ä¸‹ä¸€å±‚å¤§å°æ˜¯ä¸Šä¸€å±‚ 10 å€
- Level 2: åœ¨ Level 1 æ»¡æ—¶ï¼ŒæŠŠæ“ä½œåº”ç”¨åˆ° Level 2, ...

## æˆ‘ä»¬æ‰€å¤„çš„æ–°æ—¶ä»£

å­˜å‚¨ç³»ç»Ÿçš„åŸºæœ¬å‡è®¾ä¸€ç›´å—åˆ°æŒ‘æˆ˜

- SSD; ä½å»¶è¿Ÿã€é«˜é€Ÿé¡ºåºè¯»å†™
	- [WiscKey: Separating keys from values in SSD-conscious storage](https://www.usenix.org/conference/fast16/technical-sessions/presentation/lu "") (FAST'16)
- NVM (Intel Optane); byte addressable
- RDMA é«˜é€Ÿç½‘ç»œäº’è”
- â€¦â€¦

---

æœªæ¥ï¼Ÿ

- Transactional flash?
- SQL çš„å›å½’ (F1, TiDB, CockroachDB, ...)
- ç”šè‡³å›åˆ° â€œæ–‡ä»¶ç³»ç»Ÿâ€ï¼Ÿ

# æ€»ç»“

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : ç°ä»£åº”ç”¨ç¨‹åºå¦‚ä½•ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Ÿ

---

Takeaway messages

- æ–‡ä»¶ç³»ç»Ÿæä¾›äº†è¾ƒä¸ºç®€é™‹çš„æ–‡ä»¶ç´¢å¼•æœºåˆ¶
	- æ— æ³•ä¿è¯å¤šæ“ä½œä¹‹é—´çš„åŸå­æ€§
- ç›´æ¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿé¢ä¸´ä¸€è‡´æ€§å’Œæ€§èƒ½é—®é¢˜
	- å…³ç³»æ•°æ®åº“
	- Key-Value Store (NoSQL DB)

# End.