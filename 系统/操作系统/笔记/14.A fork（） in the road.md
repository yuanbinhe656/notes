A fork() in the Road

# A fork() in the Road

[è’‹ç‚å²©](http://ics.nju.edu.cn/~jyy "")

## Overview

å¤ä¹ 

- æˆ‘ä»¬ç†è§£äº†ä»ç³»ç»Ÿè°ƒç”¨ â†’ libc â†’ shell â†’ åº”ç”¨çš„ â€œè½¯ä»¶æ ˆâ€

---

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- èƒ½ä¸èƒ½ç”¨ç³»ç»Ÿè°ƒç”¨å®ç°æ¯”æ™®é€šä¸šåŠ¡é€»è¾‘ä»£ç æ›´æœ‰è¶£çš„ä¸œè¥¿ï¼Ÿ

---

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- æœŸä¸­æµ‹éªŒè®²è¯„
- çŠ¶æ€æœºå¤åˆ¶ (fork) çš„åº”ç”¨
- æœ‰å…³ fork çš„ä¸€äº›è®¨è®º

# æœŸä¸­æµ‹éªŒè®²è¯„

## ç®€ç­”é¢˜ï¼šå¹¶å‘æ±‚å’Œ

å¦‚æœå‡è®¾ [sum.c](https://jyywiki.cn/pages/OS/2022/demos/sum.c "") ä¸­çš„ `sum++`  æ˜¯å¦‚ä¸‹æ„æˆï¼š

- `t = atomic_fetch(sum)`
- `t++`
- `atomic_store(sum, t)`

é‚£ä¹ˆ $k$ ä¸ªçº¿ç¨‹ï¼Œè¾“å‡ºçš„æœ€å° `sum`  æ˜¯å¤šå°‘ï¼Ÿ

---

ç»“è®ºæœ‰äº›åç›´è§‰ï¼š

- å¯¹äºæ‰€æœ‰ $n, k\ge 2$ï¼Œ`sum`  çš„æœ€å°å€¼éƒ½æ˜¯ 2
- åªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æœ€åä¸€è½®å¾ªç¯ â€œæŒæœ‰â€ 2ï¼Œå†ä¿æŒåˆ°æœ€åå†™å…¥
	- Online Judge å°±é€åˆ†äº†

## æ°´é¢ä¸‹çš„å†°å±±ï¼šâ€œåç›´è§‰â€ çš„æ¥æº

Verifying Sequential Consistency (VSC) is NP-Complete

- ç»™å‡ºè‹¥å¹²çº¿ç¨‹çš„å…±äº«å†…å­˜ load/store åºåˆ—ï¼Œåˆ¤å®šæ˜¯å¦å­˜åœ¨ä¸€ä¸ª â€œå…¨å±€â€ çš„è¯»å†™é¡ºåºï¼Œä½¿å¾—çº¿ç¨‹æ€»æ˜¯è¯»åˆ°æœ€è¿‘å†™å…¥çš„æ•°å€¼

---

è¯¾åä¹ é¢˜éš¾åº¦ (3-SAT)

- é˜¶æ®µ 1: èµ‹å€¼
	- å¯¹æ¯ä¸ªå˜é‡ $x$ æ„é€  write($x$, 0) å’Œ write($x$, 1) çš„çº¿ç¨‹
- é˜¶æ®µ 2: åˆ¤å®š $C_i = x \lor \neg y$
	- (T1) read(x) = 1, write($S_i$, 1) (T2) read($y$) = 0, write($S_i$, 1)
- é˜¶æ®µ 3: æ”¶ç»“æœ
	- read($S_1$) = 1, read($S_2$) = 1, ...
- é˜¶æ®µ 4: æ”¶å°¾ (ä½¿æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½é¡ºåˆ©ç»“æŸ)
	- write($x$, 0), write($x$, 1)

## æ›´å¤šçš„æŠ€æœ¯å¤„ç†

â€œåŠ å¼ºè±ªåç‰ˆè¯¾åä¹ é¢˜â€ ğŸ˜‚

- [Testing shared memories](https://epubs.siam.org/doi/epdf/10.1137/S0097539794279614 "") (SIAM Journal on Computing'97)
- ä½¿ç”¨çš„åŒæ­¥æœºåˆ¶æ¯”åˆšæ‰çš„ â€œè¯¾åä¹ é¢˜ç‰ˆæœ¬â€ ç¨å·§å¦™ä¸€äº›

---

| VSC çš„å˜ç§               | å¤æ‚åº¦      |
| ------------------------ | ----------- |
| åˆšæ‰çš„è¯æ˜ (ä¸€èˆ¬æƒ…å†µ)    | NP-Complete |
| æ¯ä¸ªçº¿ç¨‹åªæ‰§è¡Œ 2 ä¸ªæ“ä½œ  | NP-Complete |
| åªæœ‰ 2 ä¸ªå˜é‡            | NP-Complete |
| åªæœ‰ 3 ä¸ªçº¿ç¨‹            | NP-Complete |
| æ¯ä¸ªè¯»çŸ¥é“å†™è€…           | NP-Complete |
| æ¯ä¸ªå˜é‡åªè¢«ä¸€ä¸ªçº¿ç¨‹å†™å…¥ | NP-Complete |

## ç¼–ç¨‹é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…

æŠ•æœºå–å·§çš„æ–¹æ³•ï¼š
C æ ‡å‡†åº“æ˜¯çº¿ç¨‹å®‰å…¨çš„
ï¼

```
void Tworker() {
  while (!feof(stdin) && scanf("%d", &x) == 1) {
    long res = f(x);
    lock(&lk);
    sum += res;
    unlock(&lk);
  }
}
```

---

å¦‚æœé™åˆ¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¯»ï¼Œé‚£å°±éœ€è¦ç”Ÿäº§è€…-æ¶ˆè´¹è€…äº†

## ç»Ÿè®¡ç»“æœ

æ­£ç¡®ç‡ (OJ å®æ—¶ç»Ÿè®¡é€šè¿‡ä¼¼ä¹åªç»Ÿè®¡äº†ç¼–ç¨‹é¢˜â€¦â€¦)

- ç®€ç­”é¢˜ 56/74 (75.7%)
- ç¼–ç¨‹é¢˜ 28/74 (37.8%)

---

87.5% (56/64) çš„é—®å·è¡¨ç¤º â€œæ²¡æœ‰å‡ºå–çµé­‚â€

- å¸Œæœ›å¤§å®¶ä¿æŒï¼

![](res/14.A forkï¼ˆï¼‰ in the road/cheating.png "")

# fork() è¡Œä¸ºçš„è¡¥å……è§£é‡Š

## å¤ä¹ ï¼šfork()

çŠ¶æ€æœºçš„å¤åˆ¶

- [fork-demo.c](https://jyywiki.cn/pages/OS/2022/demos/fork-demo.c "")
	- æ“ä½œç³»ç»Ÿï¼šçŠ¶æ€æœºçš„ç®¡ç†è€…
- [fork-printf.c](https://jyywiki.cn/pages/OS/2022/demos/fork-printf.c "")
	- ä¸€åˆ‡çŠ¶æ€éƒ½ä¼šè¢«å¤åˆ¶
- [sh-xv6.c](https://jyywiki.cn/pages/OS/2022/demos/sh-xv6.c "")
	- fork + execve + pipe: UNIX Shell çš„ç»å…¸è®¾è®¡
	- fork çŠ¶æ€æœºå¤åˆ¶åŒ…æ‹¬æŒæœ‰çš„æ‰€æœ‰æ“ä½œç³»ç»Ÿå¯¹è±¡
	- execve â€œé‡ç½®â€ çŠ¶æ€æœºï¼Œä½†ç»§æ‰¿æŒæœ‰çš„æ‰€æœ‰æ“ä½œç³»ç»Ÿå¯¹è±¡

## æ–‡ä»¶æè¿°ç¬¦

ç†Ÿæ‚‰åˆé™Œç”Ÿ

```
int open(const char *pathname, int flags);
```

- RTFM: `O_CLOEXEC` , `O_APPEND`

---

æ–‡ä»¶æè¿°ç¬¦ï¼šä¸€ä¸ªæŒ‡å‘æ“ä½œç³»ç»Ÿå†…å¯¹è±¡çš„ â€œæŒ‡é’ˆâ€

- å¯¹è±¡åªèƒ½é€šè¿‡æ“ä½œç³»ç»Ÿå…è®¸çš„æ–¹å¼è®¿é—®
- ä» 0 å¼€å§‹ç¼–å· (0, 1, 2 åˆ†åˆ«æ˜¯ stdin, stdout, stderr)
- å¯ä»¥é€šè¿‡ open å–å¾—ï¼›close é‡Šæ”¾ï¼›dup â€œå¤åˆ¶â€
- å¯¹äºæ•°æ®æ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¼š â€œè®°ä½â€ ä¸Šæ¬¡è®¿é—®æ–‡ä»¶çš„ä½ç½®
	- `write(3, "a", 1); write(3, "b", 1);`

## æ–‡ä»¶æè¿°ç¬¦çš„ â€œå¤åˆ¶â€

```
fd = open("a.txt", O_WRONLY | O_CREAT); assert(fd > 0);
pid_t pid = fork(); assert(pid >= 0);
if (pid == 0) {
  write(fd, "Hello");
} else {
  write(fd, "World");
}
```

---

æ–‡ä»¶æŠ½è±¡çš„ä»£ä»·

- æ“ä½œç³»ç»Ÿå¿…é¡»æ­£ç¡®ç®¡ç†å¥½åç§»é‡ (å¦‚æœæ˜¯æ—¥å¿—æ–‡ä»¶)
	- åŸå­æ€§ (RTFM: write(2), BUGS section)
- dup() çš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å…±äº« offsetï¼Œè¿˜æ˜¯ç‹¬ç«‹ offsetï¼Ÿ
	- RTFM again!

## å¤åˆ¶ï¼Œä½†åˆæ²¡æœ‰å®Œå…¨å¤åˆ¶

æ¦‚å¿µä¸ŠçŠ¶æ€æœºè¢«å¤åˆ¶ï¼Œä½†å®é™…ä¸Šå¤åˆ¶å
å†…å­˜éƒ½è¢«å…±äº«

- â€œCopy-on-writeâ€ åªæœ‰è¢«å†™å…¥çš„é¡µé¢æ‰ä¼šå¤åˆ¶ä¸€ä»½
	- è¢«å¤åˆ¶åï¼Œæ•´ä¸ªåœ°å€ç©ºé—´éƒ½è¢«æ ‡è®°ä¸º â€œåªè¯»â€
	- æ“ä½œç³»ç»Ÿæ•è· Page Fault åé…Œæƒ…å¤åˆ¶é¡µé¢
	- fork-execve æ•ˆç‡å¾—åˆ°æå‡
- æ“ä½œç³»ç»Ÿä¼šç»´æŠ¤æ¯ä¸ªé¡µé¢çš„å¼•ç”¨è®¡æ•°

---

æƒ³è¯æ˜è¿™ä¸€ç‚¹ï¼Ÿ

- [cow-test.c](https://jyywiki.cn/pages/OS/2022/demos/cow-test.c ""): 128MB ä»£ç  + 128MB æ•°æ®
- åˆ›å»º 1000 ä¸ªè¿›ç¨‹ (2GB å†…å­˜çš„è™šæ‹Ÿèƒ½æŠ—ä½å—)ï¼Ÿ
	- æ‰€ä»¥ï¼Œæ•´ä¸ªæ“ä½œç³»ç»Ÿé‡Œ libc ä»£ç å’Œåªè¯»æ•°æ®åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼
	- æ¨è®ºï¼š	
		ç»Ÿè®¡è¿›ç¨‹å ç”¨çš„å†…å­˜æ˜¯ä¸ªä¼ªå‘½é¢˜

# çŠ¶æ€æœºã€fork() å’Œé­”æ³•

## çŠ¶æ€æœºçš„è§†è§’

å¸®åŠ©æˆ‘ä»¬

- ç†è§£ç‰©ç†ä¸–ç•Œ (Cellular Automata)
- ç†è§£å¤„ç†å™¨ã€æ“ä½œç³»ç»Ÿ
- è°ƒè¯• (record-replay)ã€profiler
- Model checker å’Œ program verifier

---

fork() å¯ä»¥å¤åˆ¶çŠ¶æ€æœºï¼Ÿ

- æ„Ÿè§‰æ˜¯ä¸€ä¸ªéå¸¸ â€œå¼ºå¤§â€ çš„æ“ä½œ
- æ¯”å¦‚
	åˆ›é€ å¹³è¡Œå®‡å®™
	ï¼

## åˆ›é€ å¹³è¡Œå®‡å®™ï¼šæœç´¢å¹¶è¡ŒåŒ–

é‚£æˆ‘ä»¬ä¸å°±å¯ä»¥åŠ é€ŸçŠ¶æ€ç©ºé—´æœç´¢äº†å—ï¼Ÿ

![](res/14.A forkï¼ˆï¼‰ in the road/alphago.png "")

æ¯æ¬¡æ¢ç´¢éƒ½ fork ä¸€ä¸ªæ–°è¿›ç¨‹

- [dfs-fork.c](https://jyywiki.cn/pages/OS/2022/demos/dfs-fork.c ""): è¿å›æº¯éƒ½å¯ä»¥ä¸è¦äº†

## åˆ›é€ å¹³è¡Œå®‡å®™ï¼šè·³è¿‡åˆå§‹åŒ–

å‡è®¾ä½ å®ç°çš„ NEMU éœ€è¦å¯åŠ¨å¾ˆå¤šä»½

- `./nemu dummy.elf`
- `./nemu add.elf`
- `./nemu add-longlong.elf` ...
- è€Œä½ çš„ NEMU å®ç°åˆå§‹åŒ–åˆéœ€è¦å¾ˆé•¿çš„æ—¶é—´ï¼Ÿ

---

```
int main() {
  nemu_init(); // only once
  while (1) {
    file = get_start_request();
    if ((pid = fork()) == 0) {
      // bad practice: no error checking
      load_file();
    }
    ...
```

## åˆ›é€ å¹³è¡Œå®‡å®™ï¼šè·³è¿‡åˆå§‹åŒ–

åœ¨å®é™…ä¸­çš„åº”ç”¨

- Zygote Process (Android)
	- Java Virtual Machine åˆå§‹åŒ–æ¶‰åŠå¤§é‡çš„ç±»åŠ è½½
	- ä¸€æ¬¡åŠ è½½ï¼Œå…¨å‘˜ä½¿ç”¨	
		- App ä½¿ç”¨çš„ç³»ç»Ÿèµ„æº	
		- åŸºç¡€ç±»åº“	
		- libc	
		- ...
- Chrome site isolation (Chrome)
- Fork server (AFL)

## åˆ›é€ å¹³è¡Œå®‡å®™ï¼šå¤‡ä»½å’Œå®¹é”™

è¦æ˜¯æˆ‘ä»¬æ€»æ˜¯èƒ½ â€œè¯•ä¸€è¯•â€ï¼Œè¯•é”™äº†è¿˜èƒ½å›åˆ°è¿‡å»å°±å¥½äº†

- æœ‰ bug çš„ç¨‹åºï¼šæˆ‘ä¹Ÿæƒ³è¿™æ ·

---

é‚£å°±ç”¨ fork() åšä¸ªå¿«ç…§å§

- ä¸»è¿›ç¨‹ crash äº†ï¼Œå¯åŠ¨å¿«ç…§é‡æ–°æ‰§è¡Œ
	- æœ‰äº› bug å¯èƒ½è°ƒæ•´ä¸€ä¸‹ç¯å¢ƒå°±æ¶ˆå¤±äº† (æ¯”å¦‚å¹¶å‘)
	- [Rx: Treating bugs as allergies--A safe method to survive software failures](https://dl.acm.org/citation.cfm?id=1095833 ""). (SOSP'05, Best Paper Award ğŸ…)

![](res/14.A forkï¼ˆï¼‰ in the road/qin-rx.png "")

## çªå¦‚å…¶æ¥çš„å¹¿å‘Š

> è®¡ç®—æœºç³»ç»Ÿé‡Œæ²¡æœ‰é­”æ³•ã€‚å¤„ç†å™¨/æ“ä½œç³»ç»Ÿ/ç¨‹åºå°±æ˜¯çŠ¶æ€æœºã€‚

ä½†è¿™å°±æ˜¯é­”æ³•å•Šï¼

- ~~[ç­¾è®¢å¥‘çº¦ï¼Œæˆä¸ºé­”æ³•å°‘å¥³](https://cs.nju.edu.cn/ics/recruit/index.html "")~~  ([è¿™æ˜¯ä»€ä¹ˆæ¢—](https://zh.moegirl.org/QB%E5%A8%98 ""))

---

![](res/14.A forkï¼ˆï¼‰ in the road/qb.webp "")

ã‚­ãƒ¥ã‚¦ã¹ãˆå’Œå¤§å­¦æ•™æˆæœ‰æŸç§ç¨‹åº¦çš„ç›¸ä¼¼

~~æ€»æ˜¯åœ¨éª—ä½ ï¼Œä½†ä»ä¸è¯´å‡è¯~~

# çŠ¶æ€æœºå¤åˆ¶ï¼šæˆ‘ä»¬åšå¯¹äº†å—ï¼Ÿ

[A `fork()`  in the road](https://www.microsoft.com/en-us/research/uploads/prod/2019/04/fork-hotos19.pdf "") (HotOS'19)

## `fork()` : UNIX æ—¶ä»£çš„é—äº§

fork + execve

- å¦‚æœåªæœ‰å†…å­˜å’Œæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ˜¯ååˆ†ä¼˜é›…çš„æ–¹æ¡ˆ
- ä½†è´ªå©ªçš„äººç±»æ€ä¹ˆå¯èƒ½æ»¡è¶³ï¼Ÿ

---

åœ¨æ“ä½œç³»ç»Ÿçš„æ¼”åŒ–è¿‡ç¨‹ä¸­ï¼Œä¸ºè¿›ç¨‹å¢åŠ äº†æ›´å¤šçš„ä¸œè¥¿

- ä¿¡å· (ä¿¡å·å¤„ç†ç¨‹åºï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£ç»´æŠ¤)
- çº¿ç¨‹ (Linux ä¸ºçº¿ç¨‹æä¾›äº† clone ç³»ç»Ÿè°ƒç”¨)
- è¿›ç¨‹é—´é€šä¿¡å¯¹è±¡
- ptrace (è¿½è¸ª/è°ƒè¯•)
- â€¦â€¦

## åˆ›å»ºè¿›ç¨‹ï¼šPOSIX Spawn

```
int posix_spawn(pid_t *pid, char *path,
  posix_spawn_file_actions_t *file_actions,
  posix_spawnattr_t *attrp,
  char * argv[], char * envp[]);
```

---

å‚æ•°

- `pid` : è¿”å›çš„è¿›ç¨‹å·
- `path` : ç¨‹åº (é‡ç½®çš„çŠ¶æ€æœº)
- `file_actions` : open, close, dup
- `attrp` : ä¿¡å·ã€è¿›ç¨‹ç»„ç­‰ä¿¡æ¯
- `argv` , `envp` : åŒ `execve` 
	- å¾ˆæ˜æ˜¾ï¼šè¿™æ˜¯ä¸€ä¸ª â€œåè®¾è®¡â€ çš„ API

## A `fork()`  in the Road

fork() çš„ä¸ƒå®—ç½ª

- Fork is no longer simple
- Fork doesnâ€™t compose - [fork-printf.c](https://jyywiki.cn/pages/OS/2022/demos/fork-printf.c "")
- Fork isnâ€™t thread-safe
- Fork is insecure - æ‰“ç ´äº† Address Space Layout Randomization
- Fork is slow - çš„ç¡®â€¦â€¦
- Fork doesnâ€™t scale - ä¹Ÿæ˜¯â€¦â€¦
- Fork encourages memory overcommit - å‘ƒâ€¦â€¦

---

ä½† fork() æ˜¯é­”æ³•å•Šï¼šè¿™å¼•èµ·äº†æ›´å¤šçš„æ€è€ƒ

- åº”ç”¨ç¨‹åºåˆ°åº•éœ€è¦ä»€ä¹ˆï¼Ÿ
- æ“ä½œç³»ç»Ÿåˆ°åº•åº”è¯¥æä¾›ä»€ä¹ˆï¼Ÿ

# æ€»ç»“

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q** : å¦‚ä½•å·§å¦™åœ°ä½¿ç”¨ fork() â€œåˆ›å»ºå¹³è¡Œä¸–ç•Œâ€ çš„åŠŸèƒ½ï¼Ÿ

---

Take-away messages

- åˆ›å»ºå¹³è¡Œä¸–ç•Œ
	- æœç´¢çš„åŠ é€Ÿ
	- çŠ¶æ€çš„å¤ç”¨ (Zygote)
	- â€œæ—¶é—´æ—…è¡Œâ€â€”â€”ç©¿è¶Šåˆ°è¿‡å»ï¼Œè®©è‡ªå·±å˜å¾—æ›´å¼º
- ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦ï¼Œfork å¯èƒ½ä¸æ˜¯ API çš„æœ€ä½³é€‰æ‹©
	- å¯èƒ½å¯ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¸Šåšå‡ºéå¸¸åŸºç¡€æ€§çš„å·¥ä½œï¼

# End.