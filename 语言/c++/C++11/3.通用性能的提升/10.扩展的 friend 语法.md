`friend` 关键字在 C++ 中是一个比较特别的存在。因为在大多数编程语言中是没有提供 `friend` 关键字的，比如 Java。friend 关键字用于声明类的友元，友元可以无视类中成员的属性（ public、protected 或是 private ），友元类或友元函数都可以访问，这就`完全破坏了面向对象编程中封装性的概念`。但有的时候，friend 关键字确实会让程序猿少写很多代码，因此 friend 还是在很多程序中被使用到。

# 1\. 语法改进

在 C++11 标准中对 friend 关键字进行了一些改进，以保证其更加好用：

声明一个类为另外一个类的友元时，不再需要使用 class 关键字，并且还可以使用类的别名（使用 typedef 或者 using 定义）。

我们可以看看下面的例子：

c++

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类声明</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tom</span>;</span><br><span class="line"><span class="comment">// 定义别名</span></span><br><span class="line"><span class="keyword">using</span> Honey = Tom;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义两个测试类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Jack</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 声明友元</span></span><br><span class="line">    <span class="comment">// friend class Tom;    // C++98 标准语法</span></span><br><span class="line">    <span class="keyword">friend</span> Tom;             <span class="comment">// C++11 标准语法 </span></span><br><span class="line">    string name = <span class="string">"jack"</span>;   <span class="comment">// 默认私有</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span>            <span class="comment">// 默认私有</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        cout &lt;&lt; <span class="string">"my name is "</span> &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lucy</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// 声明友元</span></span><br><span class="line">    <span class="comment">// friend class Tom;    // C++98 标准语法</span></span><br><span class="line">    <span class="keyword">friend</span> Honey;           <span class="comment">// C++11 标准语法 </span></span><br><span class="line">    string name = <span class="string">"lucy"</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        cout &lt;&lt; <span class="string">"my name is "</span> &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tom</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="comment">// 通过类成员对象访问其私有成员</span></span><br><span class="line">        cout &lt;&lt; <span class="string">"invoke Jack private member: "</span> &lt;&lt; jObj.name &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">"invoke Jack private function: "</span> &lt;&lt; endl;</span><br><span class="line">        jObj.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">"invoke Lucy private member: "</span> &lt;&lt; lObj.name &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">"invoke Lucy private function: "</span> &lt;&lt; endl;</span><br><span class="line">        lObj.<span class="built_in">print</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string name = <span class="string">"tom"</span>;</span><br><span class="line">    Jack jObj;</span><br><span class="line">    Lucy lObj;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Tom t;</span><br><span class="line">    t.<span class="built_in">print</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

在上面的例子中 `Tom 类`分别作为了 `Jack类`和 `Lucy类`的友元类，然后在 `Tom类`中定义了 `Jack类`和 `Lucy类`的对象 `jObj` 和 `lObj`，这样我们就可以在 `Tom类`中通过这两个类对象直接访问它们各自的私有或者受保护的成员变量或者成员函数了。

# 2\. 为类模板声明友元

虽然在 C++11 标准中对友元的改进不大，却会带来应用的变化 —— 程序员可以为类模板声明友元了，这在 C++98 中是无法做到的。使用方法如下：

c++

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Tom</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">friend</span> T;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Person&lt;Tom&gt; p;</span><br><span class="line">    Person&lt;<span class="type">int</span>&gt; pp;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

- 第 11 行：`Tom类`是 `Person类`的友元
- 第 12 行：对于 `int` 类型的模板参数，友元声明被忽略（第 6 行）

这样一来，我们就可以在模板实例化时才确定一个模板类是否有友元，以及谁是这个模板类的友元。

下面基于一个实际场景来讲解一下如何给模板类指定友元：

假设有一个矩形类，一个圆形类，我们在对其进行了一系列的操作之后，需要验证一下矩形的宽度和高度、圆形的半径是否满足要求，并且要求这个校验操作要在另一个类中完成。

c++

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">friend</span> T;</span><br><span class="line">    <span class="built_in">Rectangle</span>(<span class="type">int</span> w, <span class="type">int</span> h) : <span class="built_in">width</span>(w), <span class="built_in">height</span>(h) {}</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">friend</span> T;</span><br><span class="line">    <span class="built_in">Circle</span>(<span class="type">int</span> r) : <span class="built_in">radius</span>(r) {}</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> radius;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Verify</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">verifyRectangle</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, Rectangle&lt;Verify&gt; &amp;r)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (r.width &gt;= w &amp;&amp; r.height &gt;= h)</span><br><span class="line">        {</span><br><span class="line">            cout &lt;&lt; <span class="string">"矩形的宽度和高度满足条件!"</span> &lt;&lt; endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            cout &lt;&lt; <span class="string">"矩形的宽度和高度不满足条件!"</span> &lt;&lt; endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">verifyCircle</span><span class="params">(<span class="type">int</span> r, Circle&lt;Verify&gt; &amp;c)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (r &gt;= c.radius)</span><br><span class="line">        {</span><br><span class="line">            cout &lt;&lt; <span class="string">"圆形的半径满足条件!"</span> &lt;&lt; endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            cout &lt;&lt; <span class="string">"圆形的半径不满足条件!"</span> &lt;&lt; endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Verify v;</span><br><span class="line">    <span class="function">Circle&lt;Verify&gt; <span class="title">circle</span><span class="params">(<span class="number">30</span>)</span></span>;</span><br><span class="line">    <span class="function">Rectangle&lt;Verify&gt; <span class="title">rect</span><span class="params">(<span class="number">90</span>, <span class="number">100</span>)</span></span>;</span><br><span class="line">    v.<span class="built_in">verifyCircle</span>(<span class="number">60</span>, circle);</span><br><span class="line">    v.<span class="built_in">verifyRectangle</span>(<span class="number">100</span>, <span class="number">100</span>, rect);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

- 第 28 行：在 `Verify类`中 访问了 `Rectangle类` 的私有成员变量
- 第 40 行：在 `Verify类`中 访问了 `Circle类` 的私有成员变量

程序输出的结果：

c++

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">圆形的半径满足条件!</span><br><span class="line">矩形的宽度和高度不满足条件!</span><br></pre></td></tr></tbody></table>

在上面的例子中我们定义了两个类模板 `Rectangle` 和 `Circle` 并且将其模板类型定义为了它们的友元（如果是模板类型是基础类型友元的定义就被忽略了）。在 `main()函数`中测试的时候将 `Verify` 类指定为了两个模板类的实际友元类型。这样我们在 `Verify` 类中就可以通过 `Rectangle类`和 `Circle类`的实例对象访问它们内部的私有成员变量了。

补充说明：

1. 在上面的测试程序中 `Rectangle类`和 `Circle类`我们没有提供对应的 `set方法`来设置私有成员的值，为了简化程序直接通过构造函数的初始化列表完成了它们的初始化。
2. 在上面的程序中也没有给 `Rectangle类`和 `Circle类`提供 `get方法`，这样如果想要在类外部访问私有（或受保护）成员就只能使用友元了（此处这样处理完全了为了测试的需要）。